<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>risyu-affamation</title>
    <style>
        select {
        font-size: 17px; /* フォントサイズを大きくする */
        padding: 1px;  /* 内側の余白を追加する */
    }
    .greenRow {
        background-color: #e0f2f1; /* 薄いグリーン */
    }
    .legend {
        text-align: right;
        margin-bottom: 10px;
    }
    </style>
</head>
<body>

<p>所属を選択してください</p>
<form id="gakuiki">
    <label>
        <input type="radio" name="option" value="A"> 人間社会学域
    </label>
    <label>
        <input type="radio" name="option" value="B"> 理工学域
    </label><br>
    <label>
        <input type="radio" name="option" value="C"> 医薬保健学域
    </label>
    <label>
        <input type="radio" name="option" value="D"> 融合学域
    </label><br>
</form>
<select id="ruiselect">
    <option value="blank">---</option>
</select>
<br>
<select id="nenselect">
    <option value="0">---</option>
    <option value="1">1年</option>
    <option value="2">2年</option>
    <option value="3">3年</option>
    <option value="4">4年</option>
    <option value="5">5年</option>
    <option value="6">6年以上</option>
</select>
<br>
<button onclick="executebutton()">実行</button>
<br>
<div id="checkboxContainer"></div>
<br>
<a href="{{ url_for('index') }}" onclick="return handleCompletion()">完了</a>
<script>
    document.querySelectorAll('input[name="option"]').forEach(function(radio) {
        radio.addEventListener('change', function() {
            let selectElement = document.getElementById('ruiselect');
            let selectedValue = this.value;

            // 既存の選択肢をクリア
            selectElement.innerHTML = '';

            if (selectedValue == 'A') {
                selectElement.innerHTML = `
                    <option value="---">---</option>
                    <option value="1">文系一括</option>
                    <option value="2">人文学類</option>
                    <option value="3">法学類</option>
                    <option value="4">経済学類</option>
                    <option value="5">学校教育学類</option>
                    <option value="6">地域創造学類</option>
                    <option value="7">国際学類</option>
                `;
            } else if (selectedValue == 'B') {
                selectElement.innerHTML = `
                    <option value="---">---</option>
                    <option value="1">理系一括</option>
                    <option value="2">理工３学類</option>
                    <option value="3">数物科学類</option>
                    <option value="4">物質科学類</option>
                    <option value="5">機械工学類</option>
                    <option value="6">フロンティア工学類</option>
                    <option value="7">電気情報通信学類</option>
                    <option value="8">地球社会基盤学類</option>
                    <option value="9">生命理工学類</option>
                `;
            } else if (selectedValue == 'C') {
                selectElement.innerHTML = `
                    <option value="---">---</option>
                    <option value="1">医学類</option>
                    <option value="2">薬学類</option>
                    <option value="3">医薬科学類</option>
                    <option value="4">保健学類</option>
                `;
            } else if (selectedValue == 'D') {
                selectElement.innerHTML = `
                    <option value="---">---</option>
                    <option value="1">先導学類</option>
                    <option value="2">観光デザイン学類</option>
                    <option value="3">スマート創成科学類</option>
                `;
            }
        });
    });



    var rolelist = {{ rolelist|tojson|safe }};
    rolelist = Object.keys(rolelist);
    console.log(rolelist)
    cookies = {};
    roleDict = {};
    letsgo = []
    function cookiereader() {
        console.log("Rfun[CoockieReader]")
        let kidi = document.cookie;
        let kata = kidi.split('; ');
        for (let i = 0; i < kata.length; i++) {
            let parts = kata[i].split('=');
            cookies[parts[0]] = parts[1];
        }
        console.log(cookies)
    }
    function setInitialValues() {
        if (cookies.iki) {
            let ikiRadio = document.querySelector(`input[name="option"][value="${cookies.iki}"]`);
            if (ikiRadio) {
                ikiRadio.checked = true;
                ikiRadio.dispatchEvent(new Event('change'));
            }
        }
    
        // 少しの遅延を持たせて、ruiのプルダウンメニューが更新されるのを待つ
        setTimeout(() => {
            if (cookies.rui) {
                let ruiSelect = document.getElementById('ruiselect');
                if (ruiSelect) {
                    ruiSelect.value = cookies.rui;
                }
            }
        }, 50);
    
        if (cookies.nen) {
            console.log("[setnen!!!!")
            let nenSelect = document.getElementById('nenselect');
            if (nenSelect) {
                nenSelect.value = cookies.nen;
            }
        }
    }
    



    function cookiewriter() {
        console.log("Wfun[CookieWriter]")

        let radios = document.querySelectorAll(`input[name="option"]:checked`);
        cookies.iki = radios.length > 0 ? radios[0].value : null;

        let rdropdown = document.getElementById('ruiselect');
        cookies.rui = rdropdown ? rdropdown.value : null;

        let ndropdown = document.getElementById('nenselect');
        cookies.nen = ndropdown ? ndropdown.value : null;


        let expirationDate = new Date();
        expirationDate.setFullYear(expirationDate.getFullYear() + 1); // 1年後に有効期限を設定
        let expires = "expires=" + expirationDate.toUTCString();

        for (let [key, value] of Object.entries(cookies)) {
            document.cookie = `${key}=${value}; ${expires}; path=/`;
        }
        console.log(document.cookie)
    }

    function newparson() {
        console.log("[NewPaerson]");
        letsgo = rolelist;
        for (let i = 0; i < rolelist.length; i++) {
            roleDict[rolelist[i]] = "0";
        }
    }

    function altrolever() {
        console.log("[AltRolever]");
        let diffn = rolelist.length - cookies.role.length;
        console.log(diffn);
        
        letsgo = rolelist.slice(0, diffn);
        let notInLetsgo = rolelist.filter(item => !letsgo.includes(item));
        let ushiro = {};
        for (let i = 0; i < notInLetsgo.length; i++) {
            ushiro[notInLetsgo[i]] = parseInt(cookies.role.charAt(i), 10);
        }   
        newrows = autoDict(letsgo);
        let newDict = {};
        for (let key in newrows) {
            newDict['[NEW]' + key] = newrows[key];
        }   
        roleDict = {...ushiro, ...newDict};
        setter();

        letsgo = rolelist
        letsgo = letsgo.filter(item => !item.includes('[NEW]'));
    }


    function uptodate() {
        console.log("[UpToDate]");
        letsgo = rolelist;

        for (let i = 0; i < rolelist.length; i++) {
            roleDict[rolelist[i]] = parseInt(cookies.role.charAt(i), 10);
        }
        console.log(roleDict)
        setter();
    }

    function executebutton() {
        console.log("[Button!]")

        let radios = document.querySelectorAll(`input[name="option"]:checked`);
        cookies.iki = radios.length > 0 ? radios[0].value : null;

        let rdropdownrui = document.getElementById('ruiselect');
        cookies.rui = rdropdownrui ? rdropdownrui.value : null;

        let ndropdownnen = document.getElementById('nenselect');
        cookies.nen = ndropdownnen ? ndropdownnen.value : null;

        console.log("YourAffamation");
        let youraff = ndropdownnen.value + radios[0].value + rdropdownrui.value;
        console.log(youraff);
        cookies.youraff = youraff;


        roleDict = autoDict(letsgo);
        setter();
        console.log(roleDict)
        return roleDict        
    }


    function theselector(moto, search) {
        if (moto.includes(search)) {
            if (moto.includes("限定")) {
                return 6;
            } else if (moto.includes("優先")) {
                return 7;
            } else if (moto.includes("以外")) {
                return 8;
            } else {
                return 5;
            }
        } else {
            if (moto.includes("限定")) {
                return 3;
            } else if (moto.includes("優先")) {
                return 4;
            } else if (moto.includes("以外")) {
                return 0;
            } else {
                return 3;
            }
        }
    }
    function autoDict(list) {
        malist = [ cookies.nen, cookies.iki, cookies.rui ]
        console.log("malist")
        console.log(malist)

        let ijo = [];
        let ika = [];
        for (let jo = 1; jo <= cookies.nen; jo++) {
            let label = jo + "年生以上";
            ijo.push(label);
        }
        for (let ka = cookies.nen; ka <= 6; ka++) {
            let label = ka + "年生以下";
            ika.push(label);
        }
        console.log(ijo)
        console.log(ika)
        let nen = cookies.nen + "年生";
        let nenlist = [ nen, ...ijo, ...ika ];

        for (let item of list) {
            let breakloop = false;
            for (let ma of malist) {
                console.log(`moto: ${item}, search: ${ma}, result: ${theselector(item, ma)}`);
                if (item.includes('全学生')) {
                    roleDict[item] = 0;
                    breakloop = true;
                }
                if (typeof ma === 'string' && /^[0-9]$/.test(ma)) {
                    for (let nen in nenlist) {
                        let target = nenlist[nen];
                        let result = theselector(item, target);
                        if (result >= 5) {
                            roleDict[item] = result - 5;
                        //console.log(roleDict[item])
                            breakloop = true;
                            break;
                        } else {
                            roleDict[item] = result;
                        }
                    }
                } else {
                    roleDict[item] = theselector(item, malist[ma]);
                }
                if (breakloop) {
                    break;
                }

            }
        }
        return roleDict;
        console.log("AutoDict")
        console.log(roleDict)
    }


    function setter() {
        console.log("君は完璧で究極のSetter")
        console.log(roleDict)
        let container = document.getElementById('checkboxContainer');

        container.innerHTML = '';
    
        // 凡例を追加
        let legend = document.createElement('div');
        legend.className = 'legend';
        legend.textContent = "限定 | 優先 |以外・他の限定|他の優先";
        container.appendChild(legend);
    
        // テーブルを作成
        let table = document.createElement('table');
        table.style.width = '100%'; // テーブルの幅を100%に設定
        table.style.borderCollapse = 'collapse'; // セルの境界線を1本にまとめる
    
        let rowIndex = 0;
        for (let key in roleDict) {
            let value = roleDict[key];
    
            // テーブルの行を作成
            let tr = document.createElement('tr');
    
            // 偶数行の背景色を薄いグリーンに設定
            if (rowIndex % 2 === 0) {
                tr.className = 'greenRow';
            }
            rowIndex++;
    
            // テキストのセルを追加
            let tdText = document.createElement('td');
            tdText.textContent = key;
            tr.appendChild(tdText);
    
            // 4つのチェックボックスをセルとして追加
            for (let i = 0; i < 4; i++) {
                let tdCheckbox = document.createElement('td');
                tdCheckbox.style.width = '40px'; // ここでセルの幅を固定
                tdCheckbox.style.textAlign = 'center'; // チェックボックスをセルの中央に配置
    
                let checkbox = document.createElement('input');
                checkbox.type = 'checkbox';
                checkbox.setAttribute('data-role', key);  // data-role属性を追加
    
                // valueがi+1と一致する場合、チェックボックスをチェック状態にする
                if (value === i + 1) {
                    checkbox.checked = true;
                }
    
                tdCheckbox.appendChild(checkbox);
                tr.appendChild(tdCheckbox);
            }
    
            // 行をテーブルに追加
            table.appendChild(tr);
        }
    
        // テーブルをコンテナに追加
        container.appendChild(table);
    }



    function handleCompletion() {


        for (let key in roleDict) {
            let checkboxes = document.querySelectorAll(`input[data-role="${key}"]`);
            for (let i = 0; i < checkboxes.length; i++) {
                if (checkboxes[i].checked) {
                    roleDict[key] = i + 1;
                    break;
                }
            }
        }
        console.log("[ChkReader")
        console.log(roleDict)
        let roletxt = '';
        for (let key in roleDict) {
            roletxt += roleDict[key].toString();
        }
        cookies.role = roletxt;
        cookiewriter();
        return true;
    }


    cookiereader()
    setInitialValues();
    //戻るボタン直前までの処理(途中でnewとaltは合流)
    //upはスキップ
    if (typeof cookies.role === "undefined" || cookies.role == ""){
        newparson()
    } else if (cookies.role.length == rolelist.length) {
        uptodate()
    } else {
        altrolever()
    }
    console.log(cookies)
    console.log(document.cookie);

</script>
</body>
</html>