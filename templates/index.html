<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>risyu</title>
    <style>
        /* ボタンに5ピクセルのマージンを追加 */
        #buttons button {
            margin: 5px;
        }
        .tooltip {
            position: absolute;
            border: 1px solid #ddd;
            background-color: #fff;
            padding: 5px;
            border-radius: 4px;
            z-index: 1000;
        }
    </style>
</head>
<body>
    <h id="dateDisplay"> </h>

    <br>
    <a href="{{ url_for('aff') }}"style="margin-left: 20px;">所属設定</a><a href="{{ url_for('set') }}"style="margin-left: 20px;">高度な設定</a><a href="{{ url_for('man') }}"style="margin-left: 20px;">マニュアル</a>

    <div id="buttons">
        <div><button class="day-button">月1</button><button class="day-button">火1</button><button class="day-button">水1</button><button class="day-button">木1</button><button class="day-button">金1</button><label><input type="checkbox" id="check1">GSのみ</label></div>
        <div><button class="day-button">月2</button><button class="day-button">火2</button><button class="day-button">水2</button><button class="day-button">木2</button><button class="day-button">金2</button><label><input type="checkbox" id="teaomit">教員名を省略</label></div>
        <div><button class="day-button">月3</button><button class="day-button">火3</button><button class="day-button">水3</button><button class="day-button">木3</button><button class="day-button">金3</button><label><input type="checkbox" id="check3">時間割番号を省略</label></div>
        <div><button class="day-button">月4</button><button class="day-button">火4</button><button class="day-button">水4</button><button class="day-button">木4</button><button class="day-button">金4</button><label><input type="checkbox" id="check4">優先・限定を簡略化</label></div>
        <div><button class="day-button">月5</button><button class="day-button">火5</button><button class="day-button">水5</button><button class="day-button">木5</button><button class="day-button">金5</button><label><input type="checkbox" id="check5">時間割名を省略</label></div>
        <div><button class="day-button">6限</button><button class="day-button">7限</button><button class="day-button">8限</button><button class="day-button">集中</button><select id="dropdown"><option value="0">全群</option><option value="1">1</option><option value="2">2</option><option value="3">3</option><option value="4">4</option><option value="5">5</option><option value="6">6</option></select></div>
        <div><input type="text" id="freeword"><button class="day-button">ﾌﾘｰﾜｰﾄﾞ検索</button></div>
    </div>

    <table id="myTable"></table>

    <button onclick="clearCookies()">cookieを消去</button><p>定義ファイル {{ qur }}</p>

    <p>再起動から{{ count }}人目の訪問者</p>

<script>
    function cookiewriter() {
        console.log("Wfun[CookieWriter]")
        cookies.whonlygs = document.getElementById("check1").checked ? 1 : 0;
        cookies.whotea = document.getElementById("teaomit").checked ? 1 : 0;
        cookies.whono = document.getElementById("check3").checked ? 1 : 0;
        cookies.whrya = document.getElementById("check4").checked ? 1 : 0;
        cookies.whoname = document.getElementById("check5").checked ? 1 : 0;

        let expirationDate = new Date();
        expirationDate.setFullYear(expirationDate.getFullYear() + 1); // 1年後に有効期限を設定
        let expires = "expires=" + expirationDate.toUTCString();

        for (let [key, value] of Object.entries(cookies)) {
            document.cookie = `${key}=${value}; ${expires}; path=/`;
        }
        console.log(document.cookie)
    }

    function gyomodifier(name, themat) {
        console.log("fun[gyomodifier]")
        
    }
    let toshowdata = [];
    let keyOrder = ['時間割番号', '科目区分', '時間割名', '曜日時限', '教員名', '対象学生', 'onechar', '適正人数', '全登録数', '優先指定', '第１希望', '第２希望', '第３希望', '第４希望', '第５希望'];
    function handleButtonClick(event) {

        console.log("fun[handleButtonClick]")
        buttonText = event.target.textContent;
        let freewordValue = document.getElementById("freeword").value;
        let whonlygs = document.getElementById("check1").checked;
        let whotea = document.getElementById("teaomit").checked;
        let whono = document.getElementById("check3").checked;
        let whrya = document.getElementById("check4").checked;    
        let whoname = document.getElementById("check5").checked;
        rowgun = document.getElementById("dropdown").value;

        //console.log(buttonText)
        cookiewriter()
        //console.log(cookies);
        //console.log(rowgun);


        //フィルターはじめっか
        //console.log("data")
        //console.log(data)
        //1
        toshowdata = data
            .filter(item => {
            // 科目区分がGS科目である者のみ残す（条件2）
                if (whonlygs === true && item["科目区分"] !== "ＧＳ科目") {
                    return false;
                }
       
                // 時間割番号のフィルタリング
                if (rowgun !== "0") {
                    let regex;
                    if (whono) {
                        regex = new RegExp("^" + rowgun);
                    } else {
                        regex = new RegExp("^7" + rowgun);
                    }
                    if (!regex.test(item["時間割番号"])) {
                        return false;
                    }
                }

                // 科目名のフィルタリング
                if (freewordValue) {
                    console.log(freewordValue)
                    let regex = new RegExp(freewordValue);
                    if (!regex.test(item["科目名"])) {
                        return false;
                    }
                } else {
                    buttonText = buttonText.replace('ﾌﾘｰﾜｰﾄﾞ検索', "");
                    let regex = new RegExp(buttonText);
                    if (!regex.test(item["曜日時限"])) {
                        return false;
                    }
                }
        
                return true;
            })

            .map(item => {
                // 担当教員名を削除（条件1）
                if (whotea === true) {
                    delete item["教員名"];
                    keyOrder = keyOrder.filter(key => key !== "教員名");
                }

                if (whonlygs) {
                    delete item["科目区分"];
                    keyOrder = keyOrder.filter(key => key !== "科目区分");
                }
        
                // 時間割番号の2,3文字目のみ残す（条件3）
                if (whono === true && item["時間割番号"]) {
                    item["時間割番号"] = item["時間割番号"].substring(1, 3);
                }

                // 4
                if (whrya === true) {
                    keyOrder = keyOrder.filter(key => key !== "対象学生");
                    if (item['onechar'] === "0") {
                        item['onechar'] = " - ";
                    } else if (item['onechar'] === 1) {
                        item['onechar'] = "限";
                    } else if (item['onechar'] === 2) {
                        item['onechar'] = "優";
                    } else if (item['onechar'] === 3) {
                        item['onechar'] = "GREI" + item['onechar'];
                    } else if (item['onechar'] === 4) {
                        item['onechar'] = "他";
                    } else if (item['onechar'] === 5) {
                        item['onechar'] = "次";
                    }
                } else {
                    keyOrder = keyOrder.filter(key => key !== "onechar");
                    if (item['onechar'] === "3") {
                        item['onechar'] = "GREI" + item['onechar'];
                    }
                }
                // 5
                if (whoname) {
                    //console.log(weakdict)
                    //console.log(strodict)
        
            // 科目名について、weakdict を使用して置換
                    const weakdict = {{ weakdict|tojson|safe }};
                    if (cookies.digree == "w") {
                        for (let key in weakdict) {
                            if (item['時間割名'].includes(key)) {
                                item['時間割名'] = item['時間割名'].replace(key, weakdict[key]);
                            }
                        }
                    }   
        
            // cookies.digree が "s" の場合、strodict を使用して置換
            
                    const strodict = {{ strodict|tojson|safe }};
                    if (cookies.digree == "s") {
                        for (let key in strodict) {
                            if (item['時間割名'].includes(key)) {
                                item['時間割名'] = item['時間割名'].replace(key, strodict[key]);
                            }
                        }
                    }
                }
                return item;
            });
        //console.log("toshowdata")
        //console.log(toshowdata)
        createTableFromLines(toshowdata);
    }

    let tiplist = [ "", "適正人数", "全志望者", "優先指定", "第１希望", "第２希望", "第３希望", "第４希望", "第５希望"]
    function createTableFromLines(toshowdata) {
        console.log("fun[createTableFromLines]")
        let existingTable = document.querySelector("table");
        if (existingTable) {
            existingTable.remove();
        }
    
        let table = document.createElement('table');
        
        for (let item of toshowdata) {
            //console.log(item['onechar'])
            let row = table.insertRow();
            for (let i = 0; i < keyOrder.length; i++) {
                let key = keyOrder[i];
                if (key !== "firstMinusYusen") {
                    let cell = row.insertCell();
                    let celltext = item[key];
        
                    if (typeof celltext !== 'string') {
                        celltext = celltext.toString();
                    }
        
                    if (celltext.includes("英語クラス")) {
                        celltext = celltext.replace("（英語クラス）", "");
                        celltext = '[英]' + celltext;
                    }
        
                    if (celltext.includes("GREI")) {
                        celltext = celltext.replace("GREI", "");
                        cell.style.color = "#c0c0c0";
                    } else if (celltext.includes("OBER")) {
                        celltext = celltext.replace("OBER", "");
                        cell.style.color = "#dc143c";
                        cell.style.fontWeight = "bold";
                    }
        
                    cell.textContent = celltext;
        
                    // 特定のキーのときにツールチップ用のイベントリスナーを設定
                    if (tiplist.includes(key)) {
                        cell.addEventListener('mouseover', function() {
                            // ここでツールチップを表示
                            showTooltip(cell, keyOrder[i]);
                        });
                        cell.addEventListener('mouseout', function() {
                            // ここでツールチップを非表示
                            hideTooltip();
                        });
                    }

                    if (key === "onechar") {
                        cell.addEventListener('mouseover', function() {
                            // ここでツールチップを表示
                            showTooltip(cell, item["対象学生"]);
                        });
                        cell.addEventListener('mouseout', function() {
                            // ここでツールチップを非表示
                            hideTooltip();
                        });
                    }
                }
            }
        }
        
        document.body.appendChild(table);
    }
    
    // ツールチップを表示する関数
    function showTooltip(element, text) {
        let tooltip = document.createElement("div");
        tooltip.className = "tooltip";  // CSSクラスを適用
        tooltip.innerText = text;
    
        // ツールチップの位置を計算
        let rect = element.getBoundingClientRect();
        tooltip.style.left = rect.left + window.scrollX + "px";
        tooltip.style.top = rect.bottom + window.scrollY + "px";
    
        // ツールチップを文書に追加
        document.body.appendChild(tooltip);
    }
    
    // ツールチップを非表示にする関数
    function hideTooltip() {
        let tooltips = document.querySelectorAll(".tooltip");
        tooltips.forEach(tooltip => tooltip.remove());
    }



    function clearCookies() {
        let allCookies = document.cookie.split(';');
    
        for (let i = 0; i < allCookies.length; i++) {
            let cookie = allCookies[i];
            let eqPos = cookie.indexOf("=");
            let name = eqPos > -1 ? cookie.substr(0, eqPos) : cookie;
            document.cookie = name + "=;expires=Thu, 01 Jan 1970 00:00:00 GMT; path=/";
        }
        console.log("All cookies cleared!");
    }

    let cookies = {};
    let roleDict = {};
    let data = [];

    window.addEventListener("DOMContentLoaded", function() {
        console.log("hogehoge")

        // PAGE INIT
        //document.cookie = "role" + "=; expires=Thu, 01 Jan 1970 00:00:00 UTC;";
        let asof = "{{ asof }}";
        let asofdisp = document.getElementById("dateDisplay");
        asofdisp.textContent = asof;

        console.log("[CoockieReader]")
        console.log(document.cookie)
        let kidi = document.cookie;
        let kata = kidi.split('; ');
        for (let i = 0; i < kata.length; i++) {
            let parts = kata[i].split('=');
            cookies[parts[0]] = parts[1];
        }

        const rolelist = {{ rolelist|tojson|safe }}.map(item => item.replace(/^ART/, ""));
        if (typeof cookies.role !== "undefined" || cookies.role !== "") {
            console.log("NOTnewperson")
            for (let i = 0; i < rolelist.length; i++) {
                roleDict[rolelist[i]] = parseInt(cookies.role.charAt(i), 10);
            }
            document.getElementById("check1").checked = cookies.whonlygs == 1;
            document.getElementById("teaomit").checked = cookies.whotea == 1;
            document.getElementById("check3").checked = cookies.whono == 1;
            document.getElementById("check4").checked = cookies.whrya == 1;
            document.getElementById("check5").checked = cookies.whoname == 1;
        } else {
            document.getElementById("check1").checked = true;
            document.getElementById("teaomit").checked = false;
            document.getElementById("check3").checked = true;
            document.getElementById("check4").checked = true;
            document.getElementById("check5").checked = false;
            alert("「所属設定」を行うことで\n「優先・限定を簡略化」が動作するようになります")
        } 

        const theline = "{{ theline }}".replace(/$amp;/g, '&')
        const rows = theline.trim().split('eskape').map(row => row.split(','));
        const headers = rows.shift();
        data = rows.map(row => {
            const obj = {};
            headers.forEach((header, i) => {
                obj[header] = row[i];
            });
            return obj;
        });
        data.forEach(item => {
            const firstMinusYusen = parseInt(item["第１希望"], 10) - parseInt(item["優先指定"], 10);
            item.firstMinusYusen = firstMinusYusen;
        });
        
        const flowlooper = ["優先指定", "firstMinusYusen", "第２希望", "第３希望", "第４希望", "第５希望"];
        data.forEach(item => {
            let ruiseki = 0;
            let flowflag = false;
        
            for (const key of flowlooper) {
                if (flowflag) {
                    item[key] = "GREI" + item[key];
                    if (key==="firstMinusYusen") {
                        item["第１希望"] = "GREI" + item["第１希望"];
                    }
                    continue;
                }
                ruiseki += parseInt(item[key], 10);
                if (ruiseki > parseInt(item["適正人数"], 10)) {
                    item[key] = "OBER" + item[key];
                    flowflag = true;
                    if (key === "firstMinusYusen") {
                        item["第１希望"] = "OBER" + item["第１希望"];
                    }
                }
            }
        });
    
        data.forEach(item => {
            //console.log(roleDict)
            //console.log(item["対象学生"])
            if (roleDict.hasOwnProperty(item["対象学生"])) {
                console.log("HELLO")
                item['onechar'] = roleDict[item["対象学生"]];
            }
        });
    
        let freewordValue = "";


        console.log("fugafuga")

        
        let buttons = document.querySelectorAll(".day-button");
            buttons.forEach(button => {
                console.log("fun[forEach]")
                button.addEventListener("click", handleButtonClick);
            });
        console.log("fun[onload]")
        // すべての.day-buttonを取得
        // 各ボタンにクリックイベントリスナーを追加
        buttons.forEach(function(button) {
            button.addEventListener("click", handleButtonClick);
        });



    });
</script>

</body>
</html>