<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>risyu</title>
    <style>
        /* ボタンに5ピクセルのマージンを追加 */
        #buttons button {
            margin: 5px;
        }
    </style>
</head>
<body>
    <h id="dateDisplay"> </h>

    <br>
    <a href="{{ url_for('aff') }}"style="margin-left: 20px;">所属設定</a><a href="{{ url_for('set') }}"style="margin-left: 20px;">高度な設定</a><a href="{{ url_for('man') }}"style="margin-left: 20px;">マニュアル</a>

    <div id="buttons">
        <div><button class="day-button">月1</button><button class="day-button">火1</button><button class="day-button">水1</button><button class="day-button">木1</button><button class="day-button">金1</button><label><input type="checkbox" id="check1">GSのみ</label></div>
        <div><button class="day-button">月2</button><button class="day-button">火2</button><button class="day-button">水2</button><button class="day-button">木2</button><button class="day-button">金2</button><label><input type="checkbox" id="teaomit">教員名を省略</label></div>
        <div><button class="day-button">月3</button><button class="day-button">火3</button><button class="day-button">水3</button><button class="day-button">木3</button><button class="day-button">金3</button><label><input type="checkbox" id="check3">時間割番号を省略</label></div>
        <div><button class="day-button">月4</button><button class="day-button">火4</button><button class="day-button">水4</button><button class="day-button">木4</button><button class="day-button">金4</button><label><input type="checkbox" id="check4">優先・限定を簡略化</label></div>
        <div><button class="day-button">月5</button><button class="day-button">火5</button><button class="day-button">水5</button><button class="day-button">木5</button><button class="day-button">金5</button><label><input type="checkbox" id="check5">時間割名を省略</label></div>
        <div><button class="day-button">6限</button><button class="day-button">7限</button><button class="day-button">8限</button><button class="day-button">集中</button><select id="dropdown"><option value="0">全群</option><option value="1">1</option><option value="2">2</option><option value="3">3</option><option value="4">4</option><option value="5">5</option><option value="6">6</option></select></div>
        <div><input type="text" id="freeword"><button class="day-button">ﾌﾘｰﾜｰﾄﾞ検索</button></div>
    </div>

    <table id="myTable"></table>

    <br>
    <button onclick="eraeser()">Cookieを削除する</button>

<script>
    console.log('HogeHoge')
    let settings = ["whonlygs", "whotea", "whono", "whrya", "whoname" ]
    let theline = "";
    let thelines = [];
    let sender = "";
    let cookies = {};
    let freewordValue = "";
    var weakdict = {{ weakdict|tojson|safe }};
    var strodict = {{ strodict|tojson|safe }};
    let newperson = "N";

    function pageinit() {
        console.log("fun[PageInit]")
        //document.cookie = "role" + "=; expires=Thu, 01 Jan 1970 00:00:00 UTC;";
        let asof = "{{ asof }}";
        let asofdisp = document.getElementById("dateDisplay");
        asofdisp.textContent = asof;
    //君は究極で完璧の
        theline = "{{ theline }}";
        console.log("theline_loaded!");

        let kidi = document.cookie; //クッキーを焼こう

        if (kidi == "undefined")  {
            newperson = "Y"
            initc = ["role=","whonlygs=1", "whotea=0", "whono=1", "whrya=1", "whoname=0", "digree=w"];
            initc.forEach(function (item) {
                document.cookie = item;
            });
            console.log("cookie initialized!");
        }
        cookiereader()
    //SETTER
        document.getElementById("check1").checked = cookies.whonlygs == 1;
        document.getElementById("teaomit").checked = cookies.whotea == 1;
        document.getElementById("check3").checked = cookies.whono == 1;
        document.getElementById("check4").checked = cookies.whrya == 1;
        document.getElementById("check5").checked = cookies.whoname == 1;

    //theline下準備
        theline = theline.replace(/&amp;/g, '&')
        theline = theline.replace(/eskape/g, '\n');

        let lines = theline.split('\n');
             
        for (let line of lines) {
            let elements = line.split(',');
           
            let maxer = parseInt(elements[6], 10);  // 適正人数
            let ruiseki = parseInt(elements[8], 10);  // 優先指定から開始
            let isOver = false;  // オーバーしているかどうかのフラグ
        
            if (ruiseki > maxer) {  // 優先指定の時点でオーバーしている場合
                elements[8] = 'OBER' + elements[8];
                isOver = true;  // オーバーフラグをtrueに設定
            }
        
            for (let i = 9; i <= 13; i++) {  // 第１希望から第５希望まで
                if (isOver) {  // 既にオーバーしている場合
                    elements[i] = 'GREI' + elements[i];
                    continue;  // 次のループへ
                }
        
                if (i === 9) {  // 第一希望の場合
                    ruiseki += (parseInt(elements[i], 10) - parseInt(elements[8], 10));  // 第一希望の人数から優先指定の人数を引いた値を加える
                } else {
                    ruiseki += parseInt(elements[i], 10);
                }
        
                if (ruiseki > maxer) {
                    elements[i] = 'OBER' + elements[i];
                    isOver = true;  // オーバーフラグをtrueに設定
                }
            }
            sender += elements.join(',') + '\n';
        }
    }
    
    var rolelist = {{ rolelist|tojson|safe }};
    cookies = {};
    roleDict = {};
    letsgo = [];
    buttonText = "";
    rowgun = "";
    function cookiereader() {
        console.log("Rfun[CoockieReader]")
        console.log(document.cookie)
        let kidi = document.cookie;
        let kata = kidi.split('; ');
        for (let i = 0; i < kata.length; i++) {
            let parts = kata[i].split('=');
            cookies[parts[0]] = parts[1];
        }
        if (newperson == "Y") {
            for (let i = 0; i < rolelist.length; i++) {
                roleDict[rolelist[i]] = parseInt(cookies.role.charAt(i), 10);
            }
        }
        console.log(cookies)
        console.log(roleDict)
    }
    function cookiewriter() {
        console.log("Wfun[CookieWriter]")
        console.log(cookies)
        cookies.whonlygs = document.getElementById("check1").checked ? 1 : 0;
        cookies.whotea = document.getElementById("teaomit").checked ? 1 : 0;
        cookies.whono = document.getElementById("check3").checked ? 1 : 0;
        cookies.whrya = document.getElementById("check4").checked ? 1 : 0;
        cookies.whoname = document.getElementById("check5").checked ? 1 : 0;

        let expirationDate = new Date();
        expirationDate.setFullYear(expirationDate.getFullYear() + 1); // 1年後に有効期限を設定
        let expires = "expires=" + expirationDate.toUTCString();

        for (let [key, value] of Object.entries(cookies)) {
            document.cookie = `${key}=${value}; ${expires}; path=/`;
        }
    }

    function handleButtonClick(event) {
        buttonText = event.target.textContent;
        let freewordValue = document.getElementById("freeword").value;
        let whonlygs = document.getElementById("check1").checked;
        let whotea = document.getElementById("teaomit").checked;
        let whono = document.getElementById("check3").checked;
        let whrya = document.getElementById("check4").checked;
        let whoname = document.getElementById("check5").checked;
        rowgun = document.getElementById("dropdown").value;

        console.log(buttonText)
        cookiewriter()
        console.log(cookies);


        //フィルターはじめっか
        //1
        thelines = sender.split('\n');
        if (whotea === true){
            for (let i = 0; i < thelines.length; i++) {
                thelines[i] = thelines[i].replace(/((?:[^,]*,){4})[^,]*,/, '$1'); 
            };
        }

        //2
        if (whonlygs === true){
            thelines = thelines.filter(line => line.includes("ＧＳ科目"));
            for (let i = 0; i < thelines.length; i++) {
                thelines[i] = thelines[i].replace(/((?:[^,]*,){1})[^,]*,/, '$1'); 
            };
        }

        //3
        if (whono === true) {
            for (let i = 0; i < thelines.length; i++) {
                let parts = thelines[i].split(',');
                if (parts.length > 0) {
                    parts[0] = parts[0].substring(1, 3);  // 最初の3文字だけを取得
                    thelines[i] = parts.join(',');
                }
            };
        }
        

        //4
        if (whrya === true) {
            console.log("hogehogehogehogehogeoehgoehgoehgoehgo")
            for (let i = 0; i < thelines.length; i++) {
                let parts = thelines[i].split(',');  // 各行をカンマで分割して配列にする
        
                for (let j = 0; j < parts.length; j++) {
                    for (let key in roleDict) {
                        if (parts[j] == key) {
                            if (roleDict[key] === 0) {
                                parts[j] = "";
                            } else if (roleDict[key] === 1) {
                                parts[j] = "限";
                            } else if (roleDict[key] === 2) {
                                parts[j] = "優";
                            } else if (roleDict[key] === 3) {
                                parts[j] = "外";
                            } else if (roleDict[key] === 4) {
                                parts[j] = "他";
                                parts = parts.map(item => "GREI" + item);
                            }
                        }
                    }
                }
        
                thelines[i] = parts.join(',');
            }
        }


        //5
        if (whoname === true) {
            for (let i = 0; i < thelines.length; i++) {
                for (let key in weakdict) {
                    if (thelines[i].includes(key)) {
                        thelines[i] = thelines[i].replace(key, weakdict[key]);
                    }
                }
            }
            if (cookies.digree == "s") {
                for (let i = 0; i < thelines.length; i++) {
                    for (let key in strodict) {
                        if (thelines[i].includes(key)) {
                            thelines[i] = thelines[i].replace(key, strodict[key]);
                        }
                    }
                }
            }
        }

        //filter
        let searche = "";
        if (rowgun !== "0") {
            if (whono) {
                let regex = new RegExp("^" + rowgun);
                thelines = thelines.filter(line => regex.test(line));
            } else {
                let regex = new RegExp("^7" + rowgun);
                thelines = thelines.filter(line => regex.test(line));
            }
        }
        if (freewordValue) {
            searche = freewordValue;
        } else {
            buttonText = buttonText.replace('ﾌﾘｰﾜｰﾄﾞ検索', "")
            searche = buttonText;
        }
        thelines = thelines.filter(line => line.includes(searche));

        console.log(thelines)
        createTableFromLines(thelines);
    }

    function createTableFromLines(thelines) {
        // 既存のテーブルの内容をリセット
        let table = document.getElementById("myTable");
        table.innerHTML = "";
    
        // 各行を解析してテーブルを作成
        for (let line of thelines) {
            let row = table.insertRow();
            let cells = line.split(',');
    
            for (let cellContent of cells) {
                let cell = row.insertCell();
                
                // OBERを含むセルの文字色を赤にして、文字列を取り除く
                if (cellContent.includes('OBER')) {
                    cell.style.color = "red";
                    cellContent = cellContent.replace('OBER', '');
                }
    
                // GREIを含むセルの文字色をグレーにして、文字列を取り除く
                if (cellContent.includes('GREI')) {
                    cell.style.color = "silver";
                    cellContent = cellContent.replace('GREI', '');
                }

                if (cellContent.includes('（英語クラス）')) {
                    cell.style.color = '#191970';
                    cellContent = cellContent.replace('（英語クラス）', '');
                    cellContent = "[英]" + cellContent
                }
    
                cell.textContent = cellContent;
            }
        }
    }

    function eraeser() {
        document.cookie.split(";").forEach(function(c) {
            document.cookie = c.replace(/^ +/, "").replace(/=.*/, "=;expires=" + new Date().toUTCString() + ";path=/");
        });
    }


    window.onload = function() {
        let buttons = document.querySelectorAll(".day-button");
        buttons.forEach(function(button) {
            button.addEventListener("click", handleButtonClick);
        });
    }
    document.addEventListener("DOMContentLoaded", pageinit);
    

</script>
</body>
</html>